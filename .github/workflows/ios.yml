name: iOS Build & Test

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main ]

jobs:
  build:
    name: Build iOS App (Simulator)
    runs-on: macos-latest

    steps:
    - name: Checkout Repository
      uses: actions/checkout@v4

    - name: Setup Xcode
      uses: maxim-lobanov/setup-xcode@v1
      with:
        xcode-version: latest-stable

    - name: Cache CocoaPods
      uses: actions/cache@v4
      with:
        path: Pods
        key: ${{ runner.os }}-pods-${{ hashFiles('**/Podfile.lock') }}
        restore-keys: |
          ${{ runner.os }}-pods-

    - name: Install CocoaPods
      run: |
        if [ -f "Podfile" ]; then
          pod install --repo-update
        fi

    - name: Build for iOS Simulator
      run: |
        xcodebuild \
          -project PhoneScanner.xcodeproj \
          -scheme PhoneScanner \
          -destination 'platform=iOS Simulator,name=iPhone 15,OS=latest' \
          -configuration Debug \
          clean build \
          CODE_SIGNING_ALLOWED=NO

    - name: Run Tests
      run: |
        xcodebuild \
          -project PhoneScanner.xcodeproj \
          -scheme PhoneScanner \
          -destination 'platform=iOS Simulator,name=iPhone 15,OS=latest' \
          -configuration Debug \
          test \
          CODE_SIGNING_ALLOWED=NO

    - name: Display Testing Instructions
      run: |
        echo "ðŸŽ‰ iOSç¼–è¯‘æˆåŠŸ!"
        echo ""
        echo "ðŸ“± å…è´¹æµ‹è¯•æ–¹æ¡ˆ:"
        echo "1. æ¨¡æ‹Ÿå™¨æµ‹è¯•: å½“å‰ç¼–è¯‘å·²éªŒè¯é¡¹ç›®å¯æ­£å¸¸è¿è¡Œ"
        echo "2. çœŸæœºæµ‹è¯•: å‚è€ƒé¡¹ç›®ä¸­çš„ FREE_TESTING.md æ–‡ä»¶"
        echo "3. å…è´¹Apple ID: å¯åœ¨Macä¸Šä½¿ç”¨å…è´¹Apple IDç­¾åæµ‹è¯•7å¤©"
        echo ""
        echo "ðŸ“– è¯¦ç»†æŒ‡å—: https://github.com/tuyanshuai/scanner/blob/main/FREE_TESTING.md"

    - name: Archive Build Artifacts
      uses: actions/upload-artifact@v4
      with:
        name: ios-simulator-build
        path: |
          build/
          FREE_TESTING.md
        retention-days: 30

  build-device:
    name: Build for Device (Requires Certificates)
    runs-on: macos-latest
    if: false  # é»˜è®¤ç¦ç”¨ï¼Œéœ€è¦è¯ä¹¦æ—¶å¯ç”¨

    steps:
    - name: Checkout Repository
      uses: actions/checkout@v4

    - name: Setup Xcode
      uses: maxim-lobanov/setup-xcode@v1
      with:
        xcode-version: latest-stable

    - name: Import Code Signing Certificates
      env:
        BUILD_CERTIFICATE_BASE64: ${{ secrets.BUILD_CERTIFICATE_BASE64 }}
        P12_PASSWORD: ${{ secrets.P12_PASSWORD }}
        BUILD_PROVISION_PROFILE_BASE64: ${{ secrets.BUILD_PROVISION_PROFILE_BASE64 }}
        KEYCHAIN_PASSWORD: ${{ secrets.KEYCHAIN_PASSWORD }}
      run: |
        # åˆ›å»ºä¸´æ—¶keychain
        security create-keychain -p "$KEYCHAIN_PASSWORD" build.keychain
        security default-keychain -s build.keychain
        security unlock-keychain -p "$KEYCHAIN_PASSWORD" build.keychain

        # å¯¼å…¥è¯ä¹¦
        echo $BUILD_CERTIFICATE_BASE64 | base64 --decode > certificate.p12
        security import certificate.p12 -k build.keychain -P "$P12_PASSWORD" -T /usr/bin/codesign

        # å¯¼å…¥provisioning profile
        echo $BUILD_PROVISION_PROFILE_BASE64 | base64 --decode > build_pp.mobileprovision
        mkdir -p ~/Library/MobileDevice/Provisioning\ Profiles
        cp build_pp.mobileprovision ~/Library/MobileDevice/Provisioning\ Profiles

    - name: Build and Archive
      run: |
        xcodebuild \
          -project PhoneScanner.xcodeproj \
          -scheme PhoneScanner \
          -configuration Release \
          -destination generic/platform=iOS \
          -archivePath $PWD/build/PhoneScanner.xcarchive \
          archive

    - name: Export IPA
      run: |
        xcodebuild \
          -exportArchive \
          -archivePath $PWD/build/PhoneScanner.xcarchive \
          -exportOptionsPlist exportOptions.plist \
          -exportPath $PWD/build

    - name: Upload IPA
      uses: actions/upload-artifact@v4
      with:
        name: ios-ipa
        path: build/*.ipa